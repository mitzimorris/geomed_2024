---
title: CmdStanR installation instructions for GeoMed workshop participants

format:
  html:
    css: theming/quarto_styles.css 
    syntax-definitions:
      - theming/stan.xml
    toc: true
    toc-location: left
---

For this workshop, we are using the CmdStan-based interfaces CmdStanR and CmdStanPy.
Please install the interface for your preferred language.


## Prerequisites: C++ Toolchain

Compiling a Stan program requires a modern C++ compiler and the GNU Make build utility (a.k.a. “gmake”). These vary by operating system.


### Linux

On most systems the GNU Make utility is pre-installed and is the default `make` utility.
There is usually a pre-installed C++ compiler as well, however, it may not be new enough.
To check your machine, run commands:

```bash
g++ --version
make --version
```

If these are at least at `g++` version 4.9.3 or later and
`make` version 3.81 or later, no additional installations are
necessary. It may still be desirable to update the C++ compiler `g++`, because later versions are faster.

A modern C++ compiler and GNU make are  are bundled into the meta-package `build-essential`,
and can be installed via the command:

```bash
sudo apt-get install build-essential

# then rerun checks
g++ --version
make --version
```

### Mac

* On Mac, the Clang compiler and GNU Make are included with Xcode, the Apple toolset for software developers.
Install Xcode from the App Store and then run command:\
`xcode-select --install`


### Windows

On Windows, there are two ways to get a Stan-compatible C++ toolchain:

* Use the conda installer for CmdStan, CmdStanPy or CmdStanR or RStan, since these packages all include the required toolchain.

* Get [Rtools](https://cran.r-project.org/bin/windows/Rtools/){target="_blank"}
which includes a C++17 compiler, GNU Make for windows, and a few Unix utilities.\
CmdStanR users can call the internal function `cmdstanr:::install_toolchain`.\
CmdStanPy provides both the function `cmdstanpy::get_cxx_toolchain` and command line script `get_cxx_toolchain`.


## CmdStanR Installation Instructions

All Stan R packages, including CmdStanR, are available from RUniverse.

In a fresh R session, run this command

```r
install.packages(c("cmdstanr", "posterior", "loo", "bayesplot"),
                           repos = c('https://stan-dev.r-universe.dev', getOption("repos")))
```

Next, use CmdStanR to download, build CmdStan

```r
library(cmdstanr)
install_cmdstan()

# check the installation
cmdstan_version()
cmdstan_path()
```

See CmdStanR documentation:  https://mc-stan.org/cmdstanr/articles/cmdstanr.html#installing-cmdstan


To check your work, compile and run the example model included with the CmdStan distribution.

```r
library(cmdstanr)
stan_file <- file.path(cmdstan_path(), "examples", "bernoulli", "bernoulli.stan")
data_file <- file.path(cmdstan_path(), "examples", "bernoulli", "bernoulli.data.json")

bernoulli_mod <- cmdstan_model(stan_file=stan_file)
bernoulli_fit <- bernoulli_mod$sample(data=data_file)

bernoulli_fit
```

Expected console output for the final command:

```r
> bernoulli_fit
 variable  mean median   sd  mad    q5   q95 rhat ess_bulk ess_tail
    lp__  -7.28  -6.99 0.74 0.33 -8.82 -6.75 1.00     1883     2193
    theta  0.25   0.24 0.12 0.12  0.07  0.47 1.00     1260     1458
```

### Troubleshooting

If installing CmdStanR into your current R environment fails, the fastest way to a CmdStanR installation is to use [Anaconda or miniconda](https://docs.anaconda.com/working-with-conda/packages/using-r-language/)
and [create a new environment for CmdStanR](https://docs.anaconda.com/working-with-conda/packages/using-r-language/#creating-a-new-environment-with-r).

(@) Install miniconda (installs faster than Anaconda).\
Installation instructions: [https://docs.anaconda.com/miniconda/miniconda-install/](https://docs.anaconda.com/miniconda/miniconda-install/)

(@) Open a new terminal window, check that conda has been installed\
```bash
conda --version
```


(@) Create a new environment for R\
```r
conda create -n cmdstanr -c conda-forge r-base r-essentials r-cmdstanr
conda activate cmdstanr
```

(@) From within this conda environment, i.e., the same terminal session, start R or R Studio Desktop and try again to run the following:\
```r
library(cmdstanr)
stan_file <- file.path(cmdstan_path(), "examples", "bernoulli", "bernoulli.stan")
data_file <- file.path(cmdstan_path(), "examples", "bernoulli", "bernoulli.data.json")

bernoulli_mod <- cmdstan_model(stan_file=stan_file)
bernoulli_fit <- bernoulli_mod$sample(data=data_file)

bernoulli_fit
```

### Install Spatial Packages

